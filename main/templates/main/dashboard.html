{% extends "main/layout.html"%}

{% block title %}Dashboard{% endblock %}

{%block head_extra%}
    <style>
        #new-member-card{
            height: 250px;
        }

        #status-card{
            height: 250px;
        }

        #recent-added-card{
            height: fit-content;
        }

        .cards{
            border-radius: 5px;
            background: #FFFFFF;
            box-shadow: 0px 1px 4px rgba(0, 0, 0, 0.25);
        }

        [v-cloak] {display: none}

    </style>
{%endblock%}

{%block content%}

    <div id="app" v-cloak>
        <div class="grid">

            <div id="new-member-card" class="cards g-col-12 g-col-lg-4 py-3 px-4">
                <div class="fs-2 fw-semibold " style="min-width:222px">NEW MEMBER</div>
                <div class="fw-semibold text-center" style="font-size: 6.5rem;">[[newRemedialClient.size]]</div>
            </div>

            <div id="status-card" class="cards g-col-12 g-col-lg-8 py-3 px-4">
                <div class="grid">
                    <div class="g-col-12 fs-2 fw-semibold ">NEW CUSTOMER STATS</div>
                </div>
            </div>

            <div id="recent-added-card" class="cards g-col-12 py-3 px-4">
                <div class="grid">
                    <div class="g-col-12 fs-2 fw-semibold ">NEW REMEDIAL CLIENT</div>
                    <div class="g-col-12">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>First Name</th>
                                    <th>Last Name</th>
                                    <th>Remedial Number / Suffix</th>
                                    <th>Created At</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-if="!newRemedialClient.size">
                                    <td colspan="4">No Entries Found.</td>
                                </tr>
                                <tr v-else v-for="[clientId, client] in newRemedialClient">
                                    <td>[[client.first_name]]</td>
                                    <td>[[client.last_name]]</td>
                                    <td>[[client.health_insurance_number]] / [[client.suffix]]</td>
                                    <td>[[client.date_created]]</td>
                                </tr>
                            </tbody>
                        </table>

                    </div>

                    <div class="g-col-12 fs-2 fw-semibold ">REQUIRE REMEDIAL RECEIPT</div>
                    <div class="g-col-12">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Created At</th>
                                    <th class="text-center">Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-if="!newRemedialHistory.size">
                                    <td colspan="5">No Entries Found.</td>
                                </tr>
                                <tr v-else v-for="[historyId, history] in newRemedialHistory">
                                    <td class="align-middle"><a :href="'../customers/'+ history.client_id +'/'">[[history.first_name]] [[history.last_name]]</a></td>
                                    <td class="align-middle">[[history.date_created]]</td>
                                    <td class="align-middle text-center">
                                        <span v-if="history.receipt_image" class="badge bg-success">Uploaded</span>
                                        <span v-else class="badge bg-danger">Require</span>
                                    </td>
                                    <td class="align-middle">
                                        <div style="width:200px">
                                            <input class="form-control form-control-sm" id="formFileSm" type="file" @change="uploadReceipt([[history.id]])">
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                    </div>

                    <div class="g-col-12 fs-2 fw-semibold ">MISSING REMEDIAL RECEIPT</div>
                    <div class="g-col-12">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Created At</th>
                                    <th class="text-center">Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-if="!missingRemedialReceipt.size">
                                    <td colspan="5">No Entries Found.</td>
                                </tr>
                                <tr v-else v-for="[historyId, history] in missingRemedialReceipt">
                                    <td class="align-middle"><a :href="'../customers/'+ history.client_id +'/'">[[history.first_name]] [[history.last_name]]</a></td>
                                    <td class="align-middle">[[history.date_created]]</td>
                                    <td class="align-middle text-center">
                                        <span v-if="history.receipt_image" class="badge bg-success">Uploaded</span>
                                        <span v-else class="badge bg-danger">Require</span>
                                    </td>
                                    <td class="align-middle">
                                        <div style="width:200px">
                                            <input class="form-control form-control-sm" id="formFileSm" type="file" @change="uploadReceipt([[history.id]])">
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                    </div>
                </div>
                
            </div>
            
        </div>
    </div>
    

    {% csrf_token %}
    <script>
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    </script>

    <script>
        const app = Vue.createApp({

            data() {
                
                return {
                    delay: 1000,
                    newRemedialClient: new Map(),
                    newRemedialHistory: new Map(),
                    missingRemedialReceipt: new Map()

                }
            },
            
            methods: {
                uploadReceipt(id){
                    let image = event.target.files[0]
                    let url = "../upload_receipt/"
                    let data = new FormData()
                    data.append("image", image)
                    data.append("id", id)

                    let config = {
                        headers: {
                            "X-CSRFToken": csrftoken,
                            "content-type": "multipart/form-data"
                        }
                    }

                    axios
                        .post(url, data, config)
                        .then(response=>{

                        })


                },
                dashboardConnectSocket(){
                    let _this = this
                    const dashboardSocket = new WebSocket(
                        'ws://'
                        + window.location.host
                        + '/ws/dashboard_update/'
                    );

                    dashboardSocket.onopen = function(e){
                        _this.delay = 1000
                        console.log('dashboard websocket connected successfully')
                    }


                    dashboardSocket.onmessage = function(e) {
                        const data = JSON.parse(e.data);

                        _this.dashboardWebsocketHandler(data)
                    };

                    dashboardSocket.onclose = function(e) {
                        
                        console.log(_this.delay)
                        console.error('update socket closed unexpectedly');
                        console.log(`Socket is closed. Reconnect will be attempted in ${_this.delay/1000} second.`, e.reason);
                        setTimeout(function() {
                            _this.delay = _this.delay * 2
                            _this.dashboardConnectSocket();
                        }, _this.delay);
                    };
                },  

                dashboardWebsocketHandler(data){
                    if(!data.action_type && !data.payload){
                        console.err("Bad response message")
                        return
                    }
                    console.log(data.action_type)
                    switch (data.action_type){
                        case "init_remedial_client":
                            this.initRemedialClientHandler(data.payload)
                            break
                        case "add_remedial_client":
                            this.setRemedialClientHandler(data.payload)
                            break
                        case "init_remedial_history":
                            this.initRemedialHistoryHandler(data.payload)
                            break
                        case "add_remedial_history":
                            this.setRemedialHistoryHandler(data.payload)
                            break
                        case "init_missing_receipt":
                            this.initMissingRemedialReceiptHandler(data.payload)
                            break
                        case "add_missing_receipt":
                            this.setMissingRemedialReceiptHandler(data.payload)
                            break
                
                        default:
                            
                    }
                },

                initRemedialClientHandler(data){
                    data.forEach(client =>{
                        this.newRemedialClient.set(client.id, client)
                    })
                    
                },

                setRemedialClientHandler(client){
                    this.newRemedialClient.set(client.id, client)
                },

                initRemedialHistoryHandler(data){
                    data.forEach(history=>{
                        this.newRemedialHistory.set(history.id, history)
                    })
                },

                setRemedialHistoryHandler(history){
                    
                    this.newRemedialHistory.set(history.id, history)
                },

                initMissingRemedialReceiptHandler(data){
                    console.log(data)
                    data.forEach(history=>{
                        this.missingRemedialReceipt.set(history.id, history)
                    })
                },
                
                setMissingRemedialReceiptHandler(history){
                    console.log(history)
                    this.missingRemedialReceipt.set(history.id, history)
                }

            },
            mounted() {
                this.dashboardConnectSocket()
            },
        })

        app.config.compilerOptions.delimiters = ['[[', ']]'];
        app.config.devtools = true
        app.mount("#app")
    </script>
{%endblock%}
