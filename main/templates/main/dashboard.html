{% extends "main/layout.html"%}

{% block title %}Dashboard{% endblock %}

{% load static %}


{%block head_extra%}
    <style>
        #new-member-card{
            height: 250px;
        }

        #status-card{
            height: 250px;
        }

        #recent-added-card{
            height: fit-content;
        }

        .cards{
            border-radius: 5px;
            background: #FFFFFF;
            box-shadow: 0px 1px 4px rgba(0, 0, 0, 0.25);
        }

        [v-cloak] {display: none}

    </style>
    <script type="text/javascript" src="{%static 'js/echarts.js'%}"></script>
{%endblock%}

{%block content%}

    <div id="app" v-cloak>
        <div class="grid">

            <div id="new-member-card" class="cards g-col-12 g-col-lg-4 py-3 px-4">
                <div class="fs-2 fw-semibold " style="min-width:222px">NEW MEMBER</div>
                <div class="fw-semibold text-center" style="font-size: 6.5rem;">[[newRemedialClient.size]]</div>
            </div>

            <div id="status-card" class="cards g-col-12 g-col-lg-8 py-3 px-4">
                <div class="grid"  style="grid-template-rows: 48px 1fr;height: 100%;">
                    <div class="g-col-12 fs-2 fw-semibold ">NEW CUSTOMER STATS</div>
                    <div id="new-customer-stats-bar" class="g-col-12 w-100 h-100" ></div>
                </div>
            </div>

            <div id="recent-added-card" class="cards g-col-12 py-3 px-4">
                <div class="grid">
                    <div class="g-col-12 fs-2 fw-semibold ">NEW REMEDIAL CLIENT</div>
                    <div class="g-col-12">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Remedial Number / Suffix</th>
                                    <th>Created At</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-if="!newRemedialClient.size">
                                    <td colspan="3">No Entries Found.</td>
                                </tr>
                                <tr v-else v-for="[clientId, client] in newRemedialClient">
                                    <td><a :href="'../customers/'+ client.client_id +'/'">[[client.first_name]] [[client.last_name]]</a></td>
                                    <td>[[client.health_insurance_number]] / [[client.suffix]]</td>
                                    <td>[[client.date_created]]</td>
                                </tr>
                            </tbody>
                        </table>

                    </div>

                    <div class="g-col-12 fs-2 fw-semibold ">REQUIRE REMEDIAL RECEIPT</div>
                    <div class="g-col-12">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Created At</th>
                                    <th class="text-center">Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-if="!newRemedialHistory.size">
                                    <td colspan="5">No Entries Found.</td>
                                </tr>
                                <tr v-else v-for="[historyId, history] in newRemedialHistory">
                                    <td class="align-middle"><a :href="'../customers/'+ history.client_id +'/'">[[history.first_name]] [[history.last_name]]</a></td>
                                    <td class="align-middle">[[history.date_created]]</td>
                                    <td class="align-middle text-center">
                                        <span v-if="history.receipt_image" class="badge bg-success">Uploaded</span>
                                        <span v-else class="badge bg-danger">Require</span>
                                    </td>
                                    <td class="align-middle">
                                        <div class="input-group" style="max-width: 400px;">
                                            <input class="form-control" id="formFileSm" type="file" @change="uploadReceipt([[history.id]])">
                                            <button style="" type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#exampleModal" @click="getTreatmentPlanNote(history.id)">
                                                Add Treatment Plan
                                            </button>
                                        </div>
                                        
                                        
                                        
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                    </div>

                    <div class="g-col-12 fs-2 fw-semibold ">MISSING REMEDIAL RECEIPT</div>
                    <div class="g-col-12">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Created At</th>
                                    <th class="text-center">Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-if="!missingRemedialReceipt.size">
                                    <td colspan="5">No Entries Found.</td>
                                </tr>
                                <tr v-else v-for="[historyId, history] in missingRemedialReceipt">
                                    <td class="align-middle"><a :href="'../customers/'+ history.client_id +'/'">[[history.first_name]] [[history.last_name]]</a></td>
                                    <td class="align-middle">[[history.date_created]]</td>
                                    <td class="align-middle text-center">
                                        <span v-if="history.receipt_image" class="badge bg-success">Uploaded</span>
                                        <span v-else class="badge bg-danger">Require</span>
                                    </td>
                                    <td class="align-middle">
                                        <div style="width:200px">
                                            <input class="form-control form-control-sm" id="formFileSm" type="file" @change="uploadReceipt([[history.id]])">
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                    </div>
                </div>
                
            </div>
            
        </div>

        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered ">
              <div class="modal-content">
                <div class="modal-header">
                  <!-- <h5 class="modal-title" id="exampleModalLabel">Treatment Plan</h5> -->
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="grid">
                        <div class="g-col-12">
                            <div class="form-floating">
                                <textarea class="form-control" placeholder="Leave a comment here" id="floatingTextarea2" style="height: 300px" v-model="treatmentPlanNote"></textarea>
                                <label for="floatingTextarea2">Treatment Plan</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" @click="setTreatmentPlanNote">Submit</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
        </div>
    </div>
    

    {% csrf_token %}
    <script>
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    </script>

    <script>
        let sevenDayStats = JSON.parse('{{seven_day_stats|escapejs}}')
        const app = Vue.createApp({

            data() {
                
                return {
                    delay: 1000,
                    newRemedialClient: new Map(),
                    newRemedialHistory: new Map(),
                    missingRemedialReceipt: new Map(),
                    sevenDayStats:sevenDayStats,
                    treatmentPlanNote: "",
                    treatmentPlanNoteId: null

                }
            },
            
            methods: {
                uploadReceipt(id){
                    let image = event.target.files[0]
                    let url = "../upload_receipt/"
                    let data = new FormData()
                    
                    data.append("image", image)
                    data.append("id", id)
                    
                    let config = {
                        headers: {
                            "X-CSRFToken": csrftoken,
                            "content-type": "multipart/form-data"
                        }
                    }

                    removeToast($("#loading-toast"))
                    openLoadingToast({message:"Uploading image...", id:"loading-toast"})
                    axios
                        .post(url, data, config)
                        .then(response=>{
                            removeToast($("#loading-toast"))
                            console.log(response)
                            openSuccessToast({message:"Receipt uploaded."})
                        })
                        .catch(error =>{
                            console.log(error)
                            removeToast($("#loading-toast"))
                            openErrorToast({message:JSON.stringify(error.message)})
                        })


                },
                dashboardConnectSocket(){
                    let _this = this
                    const dashboardSocket = new WebSocket(
                        'wss://'
                        + window.location.host
                        + '/ws/dashboard_update/'
                    );

                    dashboardSocket.onopen = function(e){
                        _this.delay = 1000
                        console.log('dashboard websocket connected successfully')
                    }


                    dashboardSocket.onmessage = function(e) {
                        console.log(e)
                        const data = JSON.parse(e.data);

                        _this.dashboardWebsocketHandler(data)
                    };

                    dashboardSocket.onclose = function(e) {
                        
                        console.error('update socket closed unexpectedly');
                        console.log(`Socket is closed. Reconnect will be attempted in ${_this.delay/1000} second.`, e.reason);
                        setTimeout(function() {
                            _this.delay = _this.delay * 2
                            _this.dashboardConnectSocket();
                        }, _this.delay);
                    };
                },  

                dashboardWebsocketHandler(data){
                    if(!data.action_type && !data.payload){
                        console.err("Bad response message")
                        return
                    }
                    switch (data.action_type){
                        case "init_remedial_client":
                            this.initRemedialClientHandler(data.payload)
                            break
                        case "add_remedial_client":
                            this.setRemedialClientHandler(data.payload)
                            break
                        case "init_remedial_history":
                            this.initRemedialHistoryHandler(data.payload)
                            break
                        case "add_remedial_history":
                            this.setRemedialHistoryHandler(data.payload)
                            break
                        case "init_missing_receipt":
                            this.initMissingRemedialReceiptHandler(data.payload)
                            break
                        case "add_missing_receipt":
                            this.setMissingRemedialReceiptHandler(data.payload)
                            break
                
                        default:
                            
                    }
                },

                initRemedialClientHandler(data){
                    data.forEach(client =>{
                        this.newRemedialClient.set(client.id, client)
                    })
                    
                },

                setRemedialClientHandler(client){
                    this.newRemedialClient.set(client.id, client)
                },

                initRemedialHistoryHandler(data){
                    data.forEach(history=>{
                        this.newRemedialHistory.set(history.id, history)
                    })
                },

                setRemedialHistoryHandler(history){
                    
                    this.newRemedialHistory.set(history.id, history)
                },

                initMissingRemedialReceiptHandler(data){
                    data.forEach(history=>{
                        this.missingRemedialReceipt.set(history.id, history)
                    })
                },
                
                setMissingRemedialReceiptHandler(history){
                    this.missingRemedialReceipt.set(history.id, history)
                },

                initChart(){
                    // Initialize the echarts instance based on the prepared dom
                    var myChart = echarts.init(document.getElementById('new-customer-stats-bar'));
                    
                    // Specify the configuration items and data for the chart
                    var option = {
                        tooltip: {},
                        xAxis: {
                            type: 'category',
                            data: sevenDayStats.map(result=>result.date_created),
                        },
                        yAxis: {
                            type: 'value'
                        },
                        series: [
                            {
                            data: sevenDayStats.map(result=>result.total),
                            type: 'bar'
                            }
                        ],
                        grid: {
                        left: 40,
                        top: 20,
                        right: 20,
                        bottom: 20
                        }
                    };

                    // Display the chart using the configuration items and data just specified.
                    myChart.setOption(option);
                    window.onload = function(){
                        myChart.resize()
                    }
                    window.onresize= function(){
                        myChart.resize()
                    }
                },

                getTreatmentPlanNote(id){
                    this.treatmentPlanNoteId = id
                    let url = "/get_treatment_plan_note/"

                    let data = {
                        params: {
                            id: id
                        }
                    }

                    let config = {
                        headers: {
                            "X-CSRFToken": csrftoken
                        }
                    }

                    axios
                        .get(url, data, config)
                        .then(response=>{
                            this.treatmentPlanNote = response.data.note
                        })
                        .catch(error=>{
                            console.log(error)
                        })
                },
                setTreatmentPlanNote(){
                    let url = "/set_treatment_plan_note/"
                    let data = new FormData()
                    
                    data.append("note", this.treatmentPlanNote)
                    data.append("id", this.treatmentPlanNoteId)
                    

                    let config = {
                        headers: {
                            "X-CSRFToken": csrftoken
                        }
                    }
                    
                    removeToast($("#treatment-plan-loading"))
                    openLoadingToast({message: "Submitting...", id:"treatment-plan-loading"})
                    
                    axios
                        .post(url, data, config)
                        .then(response=>{
                            this.resetTreatmentNoteAndId()
                            removeToast($("#treatment-plan-loading"))
                            openSuccessToast({message:"Treatment plan note uploaded."})

                        })
                        .catch(error=>{
                            this.resetTreatmentNoteAndId()
                            removeToast($("#treatment-plan-loading"))
                            openErrorToast({message:"Failed to contact to server."})
                        })
                },
                resetTreatmentNoteAndId(){
                    this.treatmentPlanNoteId = null
                    this.treatmentPlanNote = ""
                }

            },
            mounted() {
                this.dashboardConnectSocket()
                this.initChart()

                
            },
        })

        app.config.compilerOptions.delimiters = ['[[', ']]'];
        app.config.devtools = true
        app.mount("#app")
    </script>
{%endblock%}
