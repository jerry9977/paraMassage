{% extends "main/layout.html"%}

{% block title %}Customer{% endblock %}

{%block head_extra%}
<style>
    .cards {
        border-radius: 5px;
        background: #FFFFFF;
        box-shadow: 0px 1px 4px rgb(0 0 0 / 25%);
    }
</style>
{%endblock%}

{%block content%}
    <div id="app" v-cloak>
        <div class="grid">
            <div class="cards g-col-12 py-3 px-4">
                <div class="fs-2 fw-semibold " style="margin-bottom: 30px;">CUSTOMER DETAIL</div>
                <div class="grid">
                    <div class="g-col-12">
                        <div class="grid">
                            <div class="g-col-4 fw-semibold">First Name</div>
                            <div class="g-col-8">{{client_info.first_name}}</div>
                        </div>
                    </div>

                    <div class="g-col-12">
                        <div class="grid">
                            <div class="g-col-4 fw-semibold">Last Name</div>
                            <div class="g-col-8">{{client_info.last_name}}</div>
                        </div>
                    </div>

                    <div class="g-col-12">
                        <div class="grid">
                            <div class="g-col-4 fw-semibold">Email</div>
                            <div class="g-col-8">{{client_info.email|default:"N/A"}}</div>
                        </div>
                    </div>

                    <div class="g-col-12">
                        <div class="grid">
                            <div class="g-col-4 fw-semibold">DOB</div>
                            <div class="g-col-8">{{client_info.DOB|default:"N/A"}}</div>
                        </div>
                    </div>

                    <div class="g-col-12">
                        <div class="grid">
                            <div class="g-col-4 fw-semibold">Mobile</div>
                            <div class="g-col-8">{{client_info.mobile|default:"N/A"}}</div>
                        </div>
                    </div>

                    <div class="g-col-12">
                        <div class="grid">
                            <div class="g-col-4 fw-semibold">Home Phone</div>
                            <div class="g-col-8">{{client_info.home_phone|default:"N/A"}}</div>
                        </div>
                    </div>

                    <div class="g-col-12">
                        <div class="grid">
                            <div class="g-col-4 fw-semibold">Health Insurance / Suffix</div>
                            <div class="g-col-8">{{client_info.health_insurance_number}} / {{client_info.suffix}}</div>
                        </div>
                    </div>

                    <div class="g-col-12">
                        <div class="grid">
                            <div class="g-col-4 fw-semibold">Gender</div>
                            <div class="g-col-8">{{client_info.gender|default:"N/A"}}</div>
                        </div>
                    </div>

                    <div class="g-col-12">
                        <div class="grid">
                            <div class="g-col-4 fw-semibold">Martial Status</div>
                            <div class="g-col-8">{{client_info.martial_status|default:"N/A"}}</div>
                        </div>
                    </div>


                    <div class="g-col-12">
                        <div class="grid">
                            <div class="g-col-4 fw-semibold">Weight / Height</div>
                            <div class="g-col-8">{{client_info.Weight|default:"N/A"}} / {{client_info.Height|default:"N/A"}}</div>
                        </div>
                    </div>

                    <div class="g-col-12">
                        <div class="grid">
                            <div class="g-col-4 fw-semibold">Children</div>
                            <div class="g-col-8">{{client_info.Children|default:"N/A"}}</div>
                        </div>
                    </div>

                    <div class="g-col-12">
                        <div class="grid">
                            <div class="g-col-4 fw-semibold">Occupation</div>
                            <div class="g-col-8">{{client_info.occupation|default:"N/A"}}</div>
                        </div>
                    </div>


                    <div class="g-col-12">
                        <div class="grid">
                            <div class="g-col-4 fw-semibold">Address</div>
                            <div class="g-col-8">{{client_info.address|default:"N/A"}}</div>
                        </div>
                    </div>
                    
                    <div class="g-col-12">
                        <div class="grid">
                            <div class="g-col-4 fw-semibold">Emergency Contact Name</div>
                            <div class="g-col-8">{{client_info.emergency_contact_name|default:"N/A"}}</div>
                        </div>
                    </div>
                    
                    <div class="g-col-12">
                        <div class="grid">
                            <div class="g-col-4 fw-semibold">Emergency Contact Number</div>
                            <div class="g-col-8">{{client_info.emergency_contact_number|default:"N/A"}}</div>
                        </div>
                    </div>

                    <div class="g-col-12">
                        <div class="grid">
                            <div class="g-col-4 fw-semibold">Date Created</div>
                            <div class="g-col-8">{{client_info.date_created}}</div>
                        </div>
                    </div>
                    

                    <div class="g-col-12">
                        <a class="btn btn-primary" href="../edit/{{client_info.id}}/" style="margin-right: 10px">Edit</a>
                        <a class="btn btn-outline-primary" href="../">Back</a>
                    </div>
                </div>
                
            </div>

            <div class="cards g-col-12 py-3 px-4">
                <div class="fs-2 fw-semibold " style="margin-bottom: 30px;">REMEDIAL HISTORY</div>
                <div class="grid" style="margin-bottom: 30px">

                    <div class="accordion g-col-12" id="according-wrapper">
                        <div v-for="history in histories" class="accordion-item">
                            <h2 class="accordion-header" :id="'history-' + history.id">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" :data-bs-target="'#history-collapse-' + history.id" aria-expanded="false" :aria-controls="'history-collapse-' + history.id">
                                [[history.date_created]]
                                </button>
                            </h2>
                            <div :id="'history-collapse-' + history.id" class="accordion-collapse collapse" :aria-labelledby="'history-' + history.id" data-bs-parent="#according-wrapper">
                                <div class="grid px-4 py-4">
                                    <div class="g-col-12">
                                        <div class="grid">
                                            <div class="g-col-4 fw-semibold">Area of soreness (Front)</div>
                                            <img class="g-col-6"style="width: 100%;" :src="history.area_of_soreness_front" v-if="history.area_of_soreness_front.length">
                                            <div class="g-col-8" v-else>N/A</div>
                                            
                                        </div>
                                    </div>

                                    <div class="g-col-12">
                                        <div class="grid">
                                            <div class="g-col-4 fw-semibold">Area of soreness (Back)</div>
                                            <img class="g-col-6" style="width: 100%;" :src="history.area_of_soreness_back" v-if="history.area_of_soreness_back.length">
                                            <div class="g-col-8" v-else>N/A</div>
                                            
                                        </div>
                                    </div>
                                    


                                    <div class="g-col-12">
                                        <div class="grid">
                                            <div class="g-col-4 fw-semibold">Reason of Visit</div>
                                            <div class="g-col-8" v-if="history.reason_of_visit.length">[[history.reason_of_visit]]</div>
                                            <div class="g-col-8" v-else>N/A</div>
                                        </div>
                                    </div>

                                    <div class="g-col-12">
                                        <div class="grid">
                                            <div class="g-col-4 fw-semibold">Symptoms</div>
                                            <div class="g-col-8" v-if="history.symptoms.length">[[history.symptoms]]</div>
                                            <div class="g-col-8" v-else>N/A</div>
                                        </div>
                                    </div>

                                    <div class="g-col-12">
                                        <div class="grid">
                                            <div class="g-col-4 fw-semibold">Currently taking any medication?</div>
                                            <div class="g-col-8" v-if="history.medication.length">[[history.medication]]</div>
                                            <div class="g-col-8" v-else>N/A</div>
                                        </div>
                                    </div>

                                    <div class="g-col-12">
                                        <div class="grid">
                                            <div class="g-col-4 fw-semibold">Currently under the care of a health care professional?</div>
                                            <div class="g-col-8" v-if="history.health_care.length">[[history.health_care]]</div>
                                            <div class="g-col-8" v-else>N/A</div>
                                        </div>
                                    </div>


                                    <div class="g-col-12">
                                        <div class="grid">
                                            <div class="g-col-4 fw-semibold">Additional comments</div>
                                            <div class="g-col-8" v-if="history.additional_comments.length">[[history.additional_comments]]</div>
                                            <div class="g-col-8" v-else>N/A</div>
                                        </div>
                                    </div>

                                    <div class="g-col-12">
                                        <div class="grid">
                                            <div class="g-col-4 fw-semibold">Remedial Treatment Plan</div>
                                            <div class="g-col-8" v-if="history.remedial_treatment_plan.length" >[[history.remedial_treatment_plan]]</div>
                                            <div class="g-col-8" v-else>N/A</div>
                                        </div>
                                    </div>

                                    <div class="g-col-12">
                                        <div class="grid">
                                            <div class="g-col-4 fw-semibold">Receipt</div>
                                            <img class="g-col-6" style="width: 100%;" :src="history.receipt_image" v-if="history.receipt_image.length">
                                            <div class="g-col-6" v-else>N/A</div>
                                            
                                            

                                        </div>
                                    </div>

                                    <div class="g-col-12">
                                        <div class="grid">
                                            <div class="g-col-4 fw-semibold">Signature</div>
                                            <img class="g-col-6" style="width: 100%;"  :src="history.signature" v-if="history.signature.length">
                                            <div class="g-col-8" v-else>N/A</div>
                                        </div>
                                    </div>

                                    <div class="g-col-12">
                                        <div class="grid">
                                            <div class="g-col-4 fw-semibold">Upload Receipt / Add Treatment Plan</div>
                                            <div class="g-col-6 input-group">
                                                <input class="form-control " id="formFileSm" type="file" @change="uploadReceipt([[history.id]])">
                                                <button style="" type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#exampleModal" @click="getTreatmentPlanNote(history.id)">
                                                    Add Treatment Plan
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
        </div>

        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered ">
              <div class="modal-content">
                <div class="modal-header">
                  <!-- <h5 class="modal-title" id="exampleModalLabel">Treatment Plan</h5> -->
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="grid">
                        <div class="g-col-12">
                            <div class="form-floating">
                                <textarea class="form-control" placeholder="Leave a comment here" id="floatingTextarea2" style="height: 300px" v-model="treatmentPlanNote"></textarea>
                                <label for="floatingTextarea2">Treatment Plan</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" @click="setTreatmentPlanNote">Submit</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
        </div>
    </div>
    {% csrf_token %}
    <script>
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    </script>

    <script>
        const histories = JSON.parse('{{client_remedial_history|escapejs}}')
        const app = Vue.createApp({

            data() {
                
                return {
                    histories: histories,
                    treatmentPlanNote: "",
                    treatmentPlanNoteId: null
                }
            },
            
            methods: {
                uploadReceipt(id){
                    let image = event.target.files[0]
                    let url = "/upload_receipt/"
                    let data = new FormData()
                    
                    data.append("image", image)
                    data.append("id", id)
                    
                    let config = {
                        headers: {
                            "X-CSRFToken": csrftoken,
                            "content-type": "multipart/form-data"
                        }
                    }

                    removeToast($("#loading-toast"))
                    openLoadingToast({message:"Uploading image...", id:"loading-toast"})
                    axios
                        .post(url, data, config)
                        .then(response=>{
                            removeToast($("#loading-toast"))
                            openSuccessToast({message:"Receipt uploaded. Refresh page to see changes."})
                        })
                        .catch(error =>{
                            removeToast($("#loading-toast"))
                            openErrorToast({message:JSON.stringify(error.message)})
                        })
                },

                getTreatmentPlanNote(id){
                    this.treatmentPlanNoteId = id
                    let url = "/get_treatment_plan_note/"

                    let data = {
                        params: {
                            id: id
                        }
                    }

                    let config = {
                        headers: {
                            "X-CSRFToken": csrftoken
                        }
                    }

                    axios
                        .get(url, data, config)
                        .then(response=>{
                            this.treatmentPlanNote = response.data.note
                        })
                        .catch(error=>{
                            console.log(error)
                        })
                },
                setTreatmentPlanNote(){
                    let url = "/set_treatment_plan_note/"
                    let data = new FormData()
                    
                    data.append("note", this.treatmentPlanNote)
                    data.append("id", this.treatmentPlanNoteId)
                    

                    let config = {
                        headers: {
                            "X-CSRFToken": csrftoken
                        }
                    }
                    
                    removeToast($("#treatment-plan-loading"))
                    openLoadingToast({message: "Submitting...", id:"treatment-plan-loading"})
                    
                    axios
                        .post(url, data, config)
                        .then(response=>{
                            this.updateTreatmentPlanLocally()
                            this.resetTreatmentNoteAndId()
                            removeToast($("#treatment-plan-loading"))
                            openSuccessToast({message:"Treatment plan note uploaded."})

                        })
                        .catch(error=>{
                            this.resetTreatmentNoteAndId()
                            removeToast($("#treatment-plan-loading"))
                            openErrorToast({message:"Failed to contact to server."})
                        })
                },
                resetTreatmentNoteAndId(){
                    this.treatmentPlanNoteId = null
                    this.treatmentPlanNote = ""
                },
                updateTreatmentPlanLocally(){
                    this.histories[this.histories.findIndex(history => history.id == this.treatmentPlanNoteId)].remedial_treatment_plan = this.treatmentPlanNote
                }
            },
            mounted() {
            },
        })

        app.config.compilerOptions.delimiters = ['[[', ']]'];
        app.config.devtools = true
        app.mount("#app")
    </script>
{%endblock%}
